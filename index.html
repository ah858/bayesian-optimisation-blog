<!DOCTYPE html>

<head>
	<title>Blog</title>
 	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"/>
	<script src="https://d3js.org/d3.v6.js"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/math/5.4.0/math.js"></script> -->
	<script src="https://unpkg.com/mathjs@8.0.1/lib/browser/math.js"></script>
	<!-- MathJax script import -->
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

	<link href="style.css" rel="stylesheet" type="text/css">
</head>

<body>
	<!-- Is the padding necessary here? Could have some nice block colors otherwise-->
<article class="pa3 pa3-ns">
	<!-- Header taken from: -->
	<!-- https://tachyons.io/components/articles/left-title-top-border/index.html  -->
	<!-- TODO: CSS magic to make it stack above text if device-width < threshold -->
	<header class="fn fl-ns w-50-ns pr4-ns">
		<h1 class="f2 lh-title fw9 mb3 mt0 pt3 bt bw2">
			Bayesian Optimization
		</h1>
		<h2 class="f3 mid-gray lh-title">
			a.h. &  b.m.
		</h2>
		<time class="f6 ttu tracked gray">Publication Date XX-01-2021</time>
	</header>

	<div class="cf">
		<div class="fl w-100 w-50-ns pv1 ph3 bl bw1">
		<!-- <div class="fl w-100 w-50-ns pv1 ph3 bb bw2 bg-lightest-blue" style="border-radius: 5px;"> -->
			<div>
			<!-- <div> -->
				<p>
					Bayesian Optimization is a powerful tool for automatic optimization of design choices. It has been used extensively in applications ranging from hyperparameter tuning for automatic machine learning to optimizing manufacturing and experiment design. We'll start off by introducing a typical, illustrative  problem setting for Bayesian Optimization, and show how the key components of Bayesian Optimization can automatise design decisions while significantly improving upon naive approaches.
				</p>
				<p>
					To-dos moved to: <a href="https://github.com/ah858/bayesian-optimisation-blog/projects/1">here</a>
				</p>
			</div>
		</div>
	</div>


	<div class="mw9 center ph3-ns">

		<!-- <div class="fl w-100 w-50-ns pv0 center"> -->
		<div class="cf">
			<div class="mw5 mw7-ns center mv4 pa3 ph5-ns">


				<h2>The Problem</h2>
				<p>
					Imagine you're on the engineering design team for a Formula One car. The team lead decided that redesigning the vehicleâ€™s side wing may improve its cornering speed. A new shape has been proposed, however, the length of the side-wing, which can vary within the regulation constraints of 5cm - 40cm, is yet to be decided. Your job is to find the length of the wing that gives optimal performance as measured by the top cornering speed the driver is able to achieve.
				</p>

				<p>
					The challenge is that it is both expensive and slow to test new wing sizes. Each wing size prototype takes around a week to manufacture, install on the vehicle and get tested by the driver. There are only a few weeks left until the next Grand Prix, however, so you have limited time to find the best design.
				</p>
				<!-- !!Include something about hoping to automate the process as well. -->

		<!-- POSSIBLE FUNCTIONS -->

				<!-- <h3>Possible functions</h3> -->
				<p>
					This is a typical setting for Bayesian Optimization. In this scenario, we're trying to optimize an objective function \(f(x)\) - the vehicle's on track performance - as a function of the side-wing length \(x\). Unfortunately, we don't know what that function looks like: 
				</p>

				<!-- Posssible Functions Plot (inline) -->
		    	<div id="chart-possible-funcs"></div>
				<!-- <h2>Choosing points blindly</h2> -->
				<p>
					Since the objective function is expensive to evaluate - both in terms of time and manufacturing cost - we can only ever hope to observe the objective function at a limited number of points. Each evaluation is precious, we can't waste them.
				</p>

				<p>
					For these reasons, we need an efficient testing strategy. The tools of Bayesian Optimization are designed for situations like this.
				</p>

		        <p>
					Before we get on to how they work, however, try to have a go at picking the points yourself. There are 5 weeks left until the next race, so use the evaluations wisely:
				</p>

		    </div>
		</div>
		    

		<!-- BLIND CHOICE OF POINTS -->

		<div class="cf">
		    <div class="fl w-100 w-50-ns pv0">
		    	<div id="chart-choose-points-blind"></div>
		    	 </div>

		    <div class="fl w-100 w-50-ns ph6 pv5">
		    	<p class="i f6">We'll pick a new underlying function for you on each reset. We wouldn't want to make it too easy.</p>
		   		<!-- <a class="f6 link dim br-pill ba ph3 pv1 dib black" href="#0">Play again</a> -->
		    </div>
		</div>

		<!-- MEAN ONLY CHOICE OF POINTS -->

		<div class="cf">
			<div class="mw5 mw7-ns center mv4 pa2 ph5-ns">
		    <!-- <div class="fl w-100 w-50-ns ph2 pv0"> -->
				<h2>Using a model</h2>

				<p>
					There are multiple ways to approach picking which points to evaluate. We could try naively picking the points at random, or divide the design-space uniformly and perform a grid-search. However, both of these approaches would be inefficient - they ignore the feedback which we sequentially receive from each experiment.
				</p>

				<p>
					To pick the next point, we want to utilise the information about which previously evaluated inputs turned out to be good, and which ones turned out to be bad. We want to focus our search on the most promising areas of the design space.
				</p>

				<p>
					Instead of just picking side-wing lengths blindly, one of the central ideas of Bayesian optimization is to use a <strong>model for the data</strong> to inform that choice. This would allow us to predict what vehicle's cornering speed - our objective - might be for wing lengths we haven't tested yet. This can give us a proxy for what the most promising regions to explore might be.
				</p>

				<p>
					By using a model, we could formulate an automated strategy: pick the side-wing that is predicted to give the highest expected cornering speed by the model.
				</p>

				<!-- Plot: Choose points using only the mean of model predictions -->
				<div id="chart-choose-points-with-mean"></div>

				<p>
					You might have noticed, however, that there is an evident issue with that selection strategy.
				</p>

		    </div> <!-- No vertical padding -->
		    <div class="fl w-100 w-50-ns">
		    	<!-- <div id="chart-choose-points-with-mean"></div> -->
		    </div>
		</div>

		<!-- EXPLAIN ISSUE WITH MEAN ALONE -->

		<div class="cf">
		    <div class="fl w-100 w-50-ns ph2 pv2">
		    	<h2>Explore vs exploit - the need for exploration</h2>
		    </div>
		</div>
 
		<div class="cf sticky-container" id="test-id"> <!-- ph2-ns -->
		    <div class="fl w-100 w-50-ns ph2 pv0">
				<div class="mt6 mb4">
					<p>
						Starting with the setup on the right, let's see what would happen if we strictly followed the <i>"pick the point with the best expected cornering speed predicted by the model"</i> strategy.
					</p>
				</div>
	<!-- 				<button id="button-explore-exploit-1">Pick naive point</button>
	 -->

		    	<div id="explore-exploit-text1" >
					<div id="explore-exploit-naive-point"></div> <!-- Use a div as the event trigger because it has 0 height. If the div had a non-zero height, the bounding box would cause assymetry in the scrolling down vs scrolling up IntersectionObserver calls. -->
					<div class="mt7 mb4">
						<p>
							If we pick the best point that is predicted by the model, we end up choosing a point really close to the previously tried designs that turned out fairly well.
						</p>
					</div>
				</div>
		    	<div id="explore-exploit-text2" >
					<div id="explore-exploit-show-true"></div>
					<div class="mt7 mb4">
						<p>
							While doing so, we are ignoring other unexplored parts of the search-space. In this case, there is a whole region of shorter side-wing length where an even better design could be located.
						</p>
					</div>
				</div>

				<!-- TODO: This should pop into view separately, even though nothing happens on the plot -->
				<div class="mt6 mb4">
					<p>
						It should be clear that this greedy behaviour is bad news. There is clearly a trade-off between selecting inputs close to the 'best' points observed so far (exploiting) and traversing the design-space in search of more prospective regions (exploring). This trade-off plays a central role in Bayesian Optimization.
					</p>
				</div>

				<div class="mt6 mb4">
			    	<h3>The need for a <i>probabilistic</i> model</h3>
					<p>
						How do we know where to explore? Intuitively, we want to explore in areas where we believe there is a <strong>high probability</strong> that the design will be good. This can happen both in places where the model's mean prediction is high, or where the model's mean prediction is low, but the uncertainty in that prediction is high. Even though the expected value at a given point x might be low, if the uncertainty is high enough, the probability of that point being the best one we've seen so far might actually be substantial.
					</p>
					<p>
						To identify these high-risk high-reward regions, we need to be able to evaluate a notion of uncertainty in the model's predictions. We need a model that can give us a full predictive distribution over the possible values for the objective.
					</p>
				</div>
		    	<div id="explore-exploit-text3">
		    		<div id="explore-exploit-show-variance"></div>
					<p>
						Hence, a key component of Bayesian Optimization is to utilise a probabilistic model. Having access to the predictive distribution from such a model allows us to obtain the probability of each outcome, and consequently helps us identify good regions to explore.
					</p>
					<p>
						A model for Bayesian Optimization ought to maintain a statistical picture of the functionâ€™s overall form given our observations of it. Gaussian Processes are one popular approach to doing so for functions over continuous domains, as they give an analytical formula for the form of the predictive distribution. Here is an example:
					</p>

				</div>
		    </div> <!-- No vertical padding -->
		    <div class="fl w-100 w-50-ns ph2 pv2 sticky">
		    	<div id="chart-explore-exploit"></div>
			</div>
		</div>


		<!-- MEAN and VARIANCE CHOICE OF POINTS -->

		<div class="cf mt6">
		    <div class="fl w-100 w-50-ns ph2 pv0">
		    	<h2>Exploring uncertainty</h2>
				<div id="chart-choose-points-with-variance"></div>
			</div>
		</div>
		<div class="cf">
		<!-- Discussion of a decision rule -->
		    <div class="fl w-100 w-50-ns ph2 pv0">
				<h2>Decision Rule</h2>
				<p>
					So far, we discussed the tension between exploration and exploitation and the necessity for uncertainty estimation to balance the two. Bayesian Optimization is an automatic approach to making design choices, however; we're still missing a decision rule.
				</p>
				<h4>Acquisition Functions</h4>
				<p>
					Typically, in Bayesian Optimization approaches, one would define an acquisition function \(\alpha(x)\) which, loosely speaking, characterises the expected utility of picking a particular next input \(x\). The next input \(x\) is then automatically picked as whichever one maximises that acquisition function.For instance, for our naive approach of picking the point with the best expected cornering speed as predicted by our model, we were guided by acquisition function \(\alpha(x)\) that was equal to the expected predicted objective - \(\alpha(x) = \mathbb{E}_{y|x, \mathcal{D}}\left[y\right]\) - and we considered picking the point with the highest predicted objective:
				</p>
				<!-- TODO: Plot for simple acquisition function plot - alpha(x) = the predictive mean -->
				<p><strong>TODO:</strong> Plot showing the simple acquisition function</p>

				<p>
					This acquisition function was too greedy, however, not taking the uncertainty in the predictions into account.
				</p>

				<p>
					This raises a question: what is the right acquisition function? From our goal, can we come up with an acquisition function that would lead us to the optimal rule for choosing an \(x\)?
				</p>
				<p>
					It helps to first imagine that we're at the end of the design period, and we only have time to test one last wing prototype before we must report our inferred function minimum. Let's also say that at the end, we must return a design from the set of wing lengths we've actually tested in the lab. On the race day, we require a design we have utmost confidence in. 
				</p>

				<p>
					Our final goal is to maximise the cornering speed of our final reported design; we could say that the utility of our final design is proportional to the reported cornering speed \(y^*: U(y^*) = y^*\). We'd of course want to report the best design found, so \(y^* = max \left(y_1 \dots y_N\right)\)
				</p>

				<p>
					So far, we have tried lengths \((x_1, .., x_{N-1})\), and observed corresponding speeds \((y_1, \dots, y_{N-1})\). Given this, the <i>extra</i> utility we get from evaluating the last point at \(x_N\), and observing a cornering speed \(y_N\) is:
				</p>
				\[\lambda=\text{something cool}\]
				<!-- < start going side-by side again> -->

			</div>
		</div>


		<!-- <div class="cf"> ph2-ns
		    <div class="fl w-100 w-50-ns ph2 pv0">
		    	<p>Picking the next point</p>

			</div>
			No vertical padding
		    <div class="fl w-100 w-50-ns">
		    	<div id="chart-choose-points-with-variance"></div>
		    </div>
		</div> -->


		<!-- SANDOX GAUSSIAN -->


		<div class="cf">
		    <div class="fl w-100 w-50-ns ph2 pv0">
		    	<h2>Later blog sections</h2>
		    </div>
		</div>

		<div class="cf"> <!-- ph2-ns -->
		    <div class="fl w-100 w-50-ns ph2 pv0"> <!-- No vertical padding -->
				<button id="button1">Expected improvement</button>
		    </div>
		    <div class="fl w-100 w-50-ns">
		    	<div id="chart-gp-sandox"></div>
		    </div>
		</div>


		<div class="cf"> <!-- ph2-ns -->
		    <div class="fl w-100 w-50-ns ph2 pv0"></div> <!-- No vertical padding -->
				<div id="chart-two-step"></div>
		    <div class="fl w-100 w-50-ns"></div>
		</div>


		<div class="cf"> <!-- ph2-ns -->
		    <div class="fl w-100 w-50-ns ph2 pv0"></div> <!-- No vertical padding -->
		    <div class="fl w-100 w-50-ns"></div>
		</div>

	</div>

	<script src="./js-refactored/shared-chart-parameters.js"></script>	
	<script src="./js-refactored/chart-possible-funcs.js"></script>
	<script src="./js-refactored/chart-choose-points-blind.js"></script>	
	<script src="./js-refactored/chart-choose-points-with-mean.js"></script>
	<script src="./js-refactored/chart-explore-exploit.js"></script>		
	<script src="./js-refactored/chart-choose-points-with-variance.js"></script>		
	<script src="./js-refactored/chart-gp-sandox.js"></script>		
	<script src="./js-refactored/chart-two-step.js"></script>
        
</article>


	<!-- <h1>Bayseian optimisation</h1>

	<div class="container">

		<div class="col">
			<p>This is the first text</p>

			<p>This is the second text</p>
		</div>div>

		<div class="col">

			<svg id="dataviz_area" height=200 width=450></svg>

		</div>div>

	</div> -->

</body>
